# 介绍用户系统扩展 src/extensions/supabase/

## 一、支持数据同步
1. 本项目为客户端优先，同步数据为全量同步
2. 本地可创建数据同步到服务端
3. 多端登录后可双向同步数据
4. 同步内容为3个表：本地存储在indexeddb：note、file、file_refs

## 二、数据同步逻辑

### 增量同步
1. 只同步本地和服务器不一致的数据
2. 首次同步完成，记录最新的 lastdotime
3. 非首次同步，通过本地记录的 lastdotime 请求接口，请求 大于 lastdotime 的所有数据
4. 按时间戳顺序从旧到新同步，每次同步一条完成就更新本地时间戳，防止中途失败

### note同步逻辑

#### 核心特性
同步分为4类：1. 本地插入；2. 本地更新；3. 服务端插入；4. 服务端更新
同步唯一值：uuid
本地和服务端同时存在一条数据时如何更新：lastdotime(最后修改时间) 谁的值大就取谁
软删除机制：删除状态保留30天，超期才真正删除

#### 删除策略
30天内：保持删除状态，支持恢复
超过30天：数据同步完成后，检查超过30天永久删除，释放存储空间

### file_refs 同步逻辑
#### 同步策略
新增：本地独有 → 上传云端
更新：时间戳比较 → 新覆盖旧 (lastdotime)
删除：软删除标记 → 延迟硬删除
清理：引用计数检查 → 自动清理

#### 核心特性
增量同步：只处理变更数据，提高效率
双向同步：支持本地↔云端数据流动
冲突解决：基于时间戳的最后写入获胜策略
延迟删除：30天缓冲期防止误删
引用管理：自动清理无引用的孤立文件

### file 同步逻辑


#### 文件清理机制
检测引用计数为0的文件
首次标记为删除状态（软删除）
超过30天后执行真正删除（硬删除）