# 项目架构说明

## 架构调整说明

### 问题背景

原有架构将 PocketBase 作为一个可选的"扩展"来实现，导致以下问题：

1. **生命周期问题**：扩展组件仅在特定页面（如 `/home`）挂载时初始化，导致用户在其他页面刷新时无法建立 Realtime 连接
2. **架构不合理**：用户认证、数据同步、实时推送是应用的**核心基础功能**，不应该是可选的扩展
3. **扩展的本质混淆**：扩展应该是**可插拔的增强功能**（如主题、插件等），而不是核心依赖

### 新架构设计

将系统分为三层：

```
核心层（Core）- 抽象接口
  ├─ 认证服务（Auth Service）
  ├─ 实时连接服务（Realtime Service）
  └─ 数据同步逻辑

适配器层（Adapters）- 具体实现
  └─ PocketBase 适配器
      ├─ 认证适配器（实现 IAuthService）
      └─ Realtime 适配器（实现 IRealtimeService）

扩展层（Extensions）- UI 组件（可选）
  └─ PocketBase UI 扩展
      ├─ 登录页面
      ├─ 注册页面
      └─ 用户信息组件
```

## 目录结构

```
src/
├── core/                          # 核心层 - 抽象接口和管理器
│   ├── auth-types.ts             # 认证服务接口定义
│   ├── auth-manager.ts           # 认证管理器（单例）
│   ├── realtime-types.ts         # 实时连接服务接口定义
│   ├── realtime-manager.ts       # Realtime 管理器（单例）
│   ├── sync-*.ts                 # 同步相关逻辑
│   └── types.ts                  # 其他核心类型
│
├── adapters/                      # 适配器层 - 具体实现
│   └── pocketbase/               # PocketBase 适配器
│       ├── auth-adapter.ts       # 实现 IAuthService 接口
│       ├── realtime-adapter.ts   # 实现 IRealtimeService 接口
│       └── index.ts              # 统一导出
│
├── extensions/                    # 扩展层 - UI 组件和扩展功能
│   └── pocketbase/               # PocketBase UI 扩展
│       ├── components/           # UI 组件
│       │   ├── LoginPage.vue    # 登录页面
│       │   ├── RegisterPage.vue # 注册页面
│       │   └── UserProfile.vue  # 用户信息组件
│       ├── hooks/               # 辅助 hooks
│       ├── api/                 # API 客户端
│       └── index.ts             # 扩展入口
│
├── App.vue                       # 应用入口 - 初始化核心服务
└── main.ts                       # 主入口文件
```

## 核心概念

### 1. 核心层（Core）

**职责**：定义抽象接口，提供全局单例管理器

#### 认证服务接口（IAuthService）

```typescript
export interface IAuthService {
  signIn: (email: string, password: string) => Promise<AuthResult>
  signUp: (email: string, password: string, passwordConfirm: string, username?: string) => Promise<AuthResult>
  signOut: () => Promise<void>
  getCurrentUser: () => Promise<AuthResult>
  getCurrentAuthUser: () => UserInfo | null
  isAuthenticated: () => boolean
  getToken: () => string | null
  onAuthChange: (callback: AuthChangeCallback) => () => void
}
```

#### 认证管理器（AuthManager）

- **单例模式**：全局唯一实例
- **服务注入**：通过 `setAuthService()` 注入具体实现
- **状态管理**：管理用户登录状态、加载状态等
- **生命周期**：随应用启动而初始化

#### Realtime 服务接口（IRealtimeService）

```typescript
export interface IRealtimeService {
  connect: () => Promise<void>
  disconnect: () => void
  getStatus: () => RealtimeStatus
  isConnected: () => boolean
}
```

#### Realtime 管理器（RealtimeManager）

- **单例模式**：全局唯一实例
- **服务注入**：通过 `setRealtimeService()` 注入具体实现
- **连接管理**：管理 Realtime 连接状态
- **自动重连**：支持断线重连机制

### 2. 适配器层（Adapters）

**职责**：实现核心接口，对接具体的后端服务（PocketBase、Supabase 等）

#### PocketBase 认证适配器

```typescript
export class PocketBaseAuthAdapter implements IAuthService {
  // 实现 IAuthService 的所有方法
  // 内部使用 PocketBase SDK
}
```

#### PocketBase Realtime 适配器

```typescript
export class PocketBaseRealtimeAdapter implements IRealtimeService {
  // 实现 IRealtimeService 的所有方法
  // 内部使用 PocketBase Realtime API
}
```

**优势**：

- 如果未来需要切换到其他后端（如 Supabase），只需实现新的适配器
- 核心层和UI层完全不需要修改

### 3. 扩展层（Extensions）

**职责**：提供 UI 组件和可选的扩展功能

#### PocketBase UI 扩展

- **登录/注册页面**：独立的 UI 组件
- **用户信息组件**：显示用户资料、同步状态等
- **路由注册**：动态注册扩展相关路由

**注意**：扩展层的组件使用核心层的管理器，而不是直接使用适配器

```typescript
// ❌ 错误：直接使用适配器
import { pocketbaseAuthAdapter } from '@/adapters/pocketbase'

// ✅ 正确：使用核心管理器
import { authManager } from '@/core/auth-manager'

await authManager.login(email, password)
await pocketbaseAuthAdapter.signIn(email, password)
```

## 初始化流程

### 1. 应用启动（App.vue）

```typescript
import { pocketbaseAuthAdapter } from '@/adapters/pocketbase/auth-adapter'
import { PocketBaseRealtimeAdapter } from '@/adapters/pocketbase/realtime-adapter'
import { authManager } from '@/core/auth-manager'
import { realtimeManager } from '@/core/realtime-manager'

onMounted(async () => {
  // 1. 初始化认证服务
  authManager.setAuthService(pocketbaseAuthAdapter)
  await authManager.initialize()

  // 2. 如果用户已登录，初始化 Realtime 连接
  if (authManager.isAuthenticated()) {
    const realtimeAdapter = new PocketBaseRealtimeAdapter({
      autoReconnect: true,
      maxReconnectAttempts: 5,
      reconnectDelay: 2000,
    })

    realtimeManager.setRealtimeService(realtimeAdapter)
    await realtimeManager.connect()
  }
})
```

### 2. 用户登录

```typescript
// 在 LoginPage.vue 中
import { authManager } from '@/core/auth-manager'
import { realtimeManager } from '@/core/realtime-manager'

async function handleLogin() {
  // 1. 登录
  const result = await authManager.login(email, password)

  // 2. 建立 Realtime 连接
  const realtimeAdapter = new PocketBaseRealtimeAdapter()
  realtimeManager.setRealtimeService(realtimeAdapter)
  await realtimeManager.connect()

  // 3. 同步数据
  await sync()
}
```

### 3. 用户登出

```typescript
// 在 UserProfile.vue 中
async function handleLogout() {
  // 1. 断开 Realtime 连接
  realtimeManager.disconnect()

  // 2. 登出
  await authManager.logout()
}
```

## 优势总结

### 1. 生命周期正确

- 核心服务在 `App.vue` 中初始化，随应用启动
- Realtime 连接在用户登录时建立，不依赖特定页面
- 在任何页面刷新都能保持连接状态

### 2. 架构清晰

- **核心层**：定义抽象接口，不依赖具体实现
- **适配器层**：实现具体逻辑，可随时替换
- **扩展层**：提供 UI 组件，完全可选

### 3. 易于扩展

- 添加新的后端支持：只需实现新的适配器
- 添加新的 UI 组件：在扩展层添加
- 添加新的认证方式：实现 IAuthService 接口

### 4. 单一职责

- **核心层**：只关心"做什么"（接口定义）
- **适配器层**：只关心"怎么做"（具体实现）
- **扩展层**：只关心"怎么展示"（UI 组件）

### 5. 依赖反转

- UI 组件依赖核心接口，而不是具体实现
- 核心管理器注入具体的适配器实现
- 符合 SOLID 原则中的依赖倒置原则（DIP）

## 未来改进

1. **多后端支持**：实现 Supabase 适配器，支持用户选择后端
2. **离线优先**：增强本地缓存和冲突解决机制
3. **插件系统**：允许第三方开发者编写适配器和扩展
4. **类型安全**：使用 TypeScript 泛型进一步增强类型安全

## 迁移指南

如果你的代码还在使用旧的扩展 `useAuth()` hook：

```typescript
// ✅ 新代码
import { authManager } from '@/core/auth-manager'

// ❌ 旧代码
import { useAuth } from '@/extensions/pocketbase/hooks/useAuth'

const { login, logout, currentUser } = useAuth()
const currentUser = authManager.userInfo
await authManager.login(email, password)
await authManager.logout()
```

## 总结

新架构将用户系统从"可选扩展"提升为"核心服务"，解决了生命周期问题，同时保持了架构的灵活性和可扩展性。核心服务在应用启动时初始化，确保在任何页面都能正常工作。
